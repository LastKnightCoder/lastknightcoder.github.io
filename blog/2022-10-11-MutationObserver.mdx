---
slug: MutationObserver
tags: 
  - MutationObserver
  - DOM
authors: xiongtao
date: 2022-10-11
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

åœ¨å¤æ‚çš„ç½‘é¡µåº”ç”¨ä¸­ï¼ŒDOM ç»“æ„ä¼šé¢‘ç¹çš„å‘ç”Ÿå˜åŒ–ï¼Œæœ‰çš„æ—¶å€™æˆ‘ä»¬éœ€è¦æ ¹æ®å˜åŒ–æ¥è¿›è¡Œç›¸åº”çš„æ“ä½œï¼Œä»¥å¾€é€šè¿‡ `Mutation Events` æ¥ç›‘å¬ DOM çš„å˜åŒ–ï¼Œç›®å‰å®ƒå·²ç»åºŸå¼ƒäº†ï¼Œè¢« `MutationObserver` æ‰€å–ä»£ã€‚`MutationObserver` çš„å…¼å®¹æ€§å¾ˆå¥½ï¼Œå¯ä»¥æ”¾å¿ƒå¤§èƒ†çš„ä½¿ç”¨ã€‚

<img src="https://cdn.staticaly.com/gh/LastKnightCoder/ImgHosting3@master/image.70ve24867iw.webp" style={{ zoom: '50%'}} />

## åŸºæœ¬ç”¨æ³•

`MutationObserver` çš„åŸºæœ¬ç”¨æ³•å¦‚ä¸‹

```js
const observer = new MutationObserver(mutations => {

});
observer.observe(element, options);
```

<!--truncate-->

æˆ‘ä»¬é€šè¿‡ `new MutationObserver()` åˆ›å»ºä¸€ä¸ª `MutationObserver` å¯¹è±¡ï¼Œæ„é€ å‡½æ•°æ¥æ”¶ä¸€ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œå½“è¢«ç›‘å¬çš„å…ƒç´  DOM å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè¯¥å›è°ƒå‡½æ•°å°†ä¼šæ‰§è¡Œã€‚

å›è°ƒå‡½æ•°æ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œè¯¥å‚æ•°æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå…¶ä¸­å…ƒç´ ç±»å‹ä¸º `MutationRecord`ï¼Œ`MutationRecord` åŒ…å«å¦‚ä¸‹å±æ€§ï¼š

```js
{
	type: 'attributes',
	target: div#container,
	addedNodes: [],
	removeNodes: [],
	previousSibling: null,
	nextSibling: null,
	attributeName: '',
	attributeNamespace: null,
	oldValue: ''
}
```

åœ¨åç»­å†…å®¹ä¸­ä¼šè¯¦ç»†ä»‹ç»æ¯ä¸ªå­—æ®µçš„ä½œç”¨ã€‚

é€šè¿‡ `observe(element, options)` å¯¹å…ƒç´  `element` è¿›è¡Œç›‘å¬ï¼Œé™¤äº†éœ€è¦ä¼ å…¥è¦ç›‘å¬çš„å…ƒç´ ä»¥å¤–ï¼Œè¿˜éœ€è¦ä¼ é€’ä¸€ä¸ª `options` å¯¹è±¡ï¼Œå®ƒåŒ…æ‹¬å¦‚ä¸‹å­—æ®µï¼š

```js
{
	childList: true,
	attributes: true,
	attributeFilter: ['class', 'style'],
	attributeOldValue: true,
	characterData: true,
	characterDataOldValue: true,
	subtree: true
}
```

è¿™é‡Œä¸ºäº†å®Œæ•´æ€§å°†å¯è®¾ç½®çš„æ‰€æœ‰å‚æ•°åˆ—äº†å‡ºæ¥ï¼Œå®é™…åœ¨ `options` å‚æ•°å¹¶ä¸éœ€è¦æŒ‡å®šæ¯ä¸€ä¸ªå±æ€§ã€‚

å¯ä»¥è§‚å¯Ÿåˆ°é™¤äº† `attributeFilter` å±æ€§å¤–ï¼Œå…¶å®ƒå±æ€§éƒ½æ˜¯å¸ƒå°”å€¼ï¼Œä¹Ÿå°±è¯´è¿™äº›å±æ€§ç›¸å½“äºä¸€ä¸ªå¼€å…³ï¼Œè®¾ç½®æŸä¸ªå±æ€§ä¸º `true` å°±ç›¸å½“äºå¼€å¯æŸä¸ªç‰¹æ€§ï¼Œåé¢ä¼šè¯¦ç»†ä»‹ç»æ¯ä¸ªå±æ€§çš„ä½œç”¨ã€‚

:::note note
è™½ç„¶ä¸éœ€è¦æŒ‡å®šæ¯ä¸€ä¸ªå±æ€§ï¼Œä½†æ˜¯ `childList`, `attributes`, `characterData` è¿™ä¸‰ä¸ªå±æ€§å¿…é¡»æœ‰ä¸€ä¸ªè®¾ç½®ä¸º `true`ã€‚
:::

å¦‚æœä¸å†éœ€è¦ç›‘å¬ DOM çš„å˜åŒ–æ—¶ï¼Œå¯ä»¥é€šè¿‡ `observer.disconnect()` æ–¹æ³•åœæ­¢ç›‘å¬ã€‚

æ¥çœ‹ä¸€ä¸ªğŸŒ°ã€‚

<Tabs>
<TabItem value='html' label='HTML' default>

```html
<div id="container">
  <p>ä¸–ç•Œè¿™ä¹ˆå¤§ï¼Œæˆ‘æƒ³å»çœ‹çœ‹</p>
</div>
<button id="btn">åˆ é™¤å…ƒç´ </button>
```

</TabItem>

<TabItem value='js' label='JavaScript'>

```js
const observer = new MutationObserver(mutations => {
  console.log(mutations);
});
observer.observe(document.getElementById('container'), {
  childList: true
});

const btn = document.getElementById('btn');
btn.addEventListener('click', () => {
  document.getElementById('container').removeChild(
    document.querySelector('#container p')
  );
});
```  

</TabItem>
</Tabs>

é¡µé¢ä¸­æœ‰ä¸€ä¸ª `id` ä¸º `container` çš„å…ƒç´ ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ª `p` æ ‡ç­¾ï¼Œ `p` æ ‡ç­¾ä¸­å…¶ä¸­åŒ…å«ä¸€äº›æ–‡å­—ã€‚é¡µé¢ä¸­è¿˜æœ‰ä¸€ä¸ªæŒ‰é’®ï¼Œå½“ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œä¼šå°† `p` æ ‡ç­¾ä» `container` ä¸­ç§»é™¤ã€‚

ç°åœ¨æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª `MutationObserver`ï¼Œå¹¶ç›‘å¬äº† `container` å…ƒç´ ï¼Œè®¾ç½® `options` ä¸­çš„ `childList` ä¸º `true`ï¼Œè¡¨ç¤ºå½“ `container` çš„å­èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–æ—¶ï¼ˆæ–°å¢æˆ–åˆ é™¤ï¼‰ï¼Œå°†ä¼šè¢«ç›‘å¬åˆ°ï¼Œä»è€Œè§¦å‘å›è°ƒå‡½æ•°çš„æ‰§è¡Œã€‚åœ¨å›è°ƒå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯ç®€å•çš„æ‰“å°äº†å›è°ƒå‡½æ•°çš„å‚æ•°ã€‚

å¯ä»¥è§‚å¯Ÿåˆ°ï¼Œå½“æˆ‘ä»¬åˆ é™¤ `p` æ ‡ç­¾æ—¶ï¼Œæ§åˆ¶å°æ‰“å°äº†å†…å®¹ï¼Œè¡¨ç¤º `container` çš„å˜åŒ–è¢«ç›‘å¬åˆ°äº†ã€‚

<video controls src="https://video-obsidian.oss-cn-beijing.aliyuncs.com/MutationObserver-base.mp4"></video>

:::info info
é€šè¿‡ `MutationObserver` å¯ä»¥ç›‘è§†åˆ°ä¸‰ç§ DOM å˜åŒ–ï¼š

1. å­å…ƒç´ å‘ç”Ÿå˜åŒ–ï¼ˆæ–°å¢æˆ–åˆ é™¤ï¼‰
2. å±æ€§å‘ç”Ÿå˜åŒ–
3. åŒ…å«çš„æ–‡æœ¬å‘ç”Ÿå˜åŒ–

å¯é€šè¿‡ `MutationRecord` å¯¹è±¡çš„ `type` å±æ€§æ¥åŒºåˆ†æ˜¯ä½•ç§å˜åŒ–ï¼Œå®ƒæœ‰ä¸‰ä¸ªå€¼åˆ†åˆ«ä¸ä¸Šè¿°å˜åŒ–å¯¹åº”ï¼š

1. `childList`
2. `attributes`
3. `characterData`
:::

## é€šè¿‡ `childList` æ¥ç›‘å¬å­å…ƒç´ çš„å˜åŒ–

### childList

å½“ `options` ä¸­çš„ `childList` è®¾ç½®ä¸º `true` æ—¶ï¼Œè¡¨ç¤ºç›‘å¬å­å…ƒç´ çš„å˜åŒ–ï¼Œå³å­å…ƒç´ çš„æ–°å¢ä¸åˆ é™¤ã€‚

åŒæ ·åœ¨é¡µé¢ä¸Šå­˜åœ¨ä¸€ä¸ª `container` å…ƒç´ ï¼Œå…¶ä¸­åŒ…å«äº†ä¸€ä¸ª `p` æ ‡ç­¾ï¼›é¡µé¢ä¸ŠåŒæ—¶å­˜åœ¨ä¸€ä¸ªæŒ‰é’®ï¼Œå½“ç‚¹å‡»æŒ‰é’®æ—¶ä¼šåˆ é™¤ `p` æ ‡ç­¾æˆ–è€…åˆ›å»º `p` æ ‡ç­¾ã€‚

<Tabs>
<TabItem value='html' label='HTML' default>

```html
<div id="container">
  <p>ä¸–ç•Œè¿™ä¹ˆå¤§ï¼Œæˆ‘æƒ³å»çœ‹çœ‹</p>
</div>
<button id="btn">åˆ é™¤/æ–°å¢</button>
```

</TabItem>

<TabItem value='js' label='JavaScript'>

```js
const container = document.querySelector('#container');
const observer = new MutationObserver(mutations => {
  console.log(mutations);
});
observer.observe(container, {
  childList: true
});

const btn = document.querySelector('#btn');
btn.addEventListener('click', () => {
  const p = container.querySelector('p');
  if (p) {
    container.removeChild(p);
  } else {
    container.innerHTML = '<p>ä¸–ç•Œè¿™ä¹ˆå¤§ï¼Œæˆ‘æƒ³å»çœ‹çœ‹</p>';
  }
});
```  

</TabItem>
</Tabs>

<video controls src="https://video-obsidian.oss-cn-beijing.aliyuncs.com/MutationObserver-childList1.mp4"></video>

ä»è§†é¢‘å¯ä»¥è§‚å¯Ÿåˆ°ï¼Œå½“ `p` æ ‡ç­¾çš„åˆ é™¤ä¸æ–°å¢æ—¶ï¼Œå‡ä¼šè§¦å‘å›è°ƒå‡½æ•°çš„æ‰§è¡Œã€‚

é€šè¿‡ `MutationRecord` å¯¹è±¡çš„ `addedNodes` ä¸ `removedNodes` å±æ€§å¯ä»¥è®¿é—®åˆ°æ·»åŠ çš„èŠ‚ç‚¹ä»¥åŠåˆ é™¤çš„èŠ‚ç‚¹ã€‚é€šè¿‡ `nextSibling` ä¸ `prevSibling` å¯ä»¥è·å¾—è¢«åˆ é™¤æˆ–æ–°å¢èŠ‚ç‚¹çš„å‰åå…„å¼ŸèŠ‚ç‚¹ï¼ˆå¦‚æœä¸å­˜åœ¨åˆ™ä¸º `null`ï¼‰ã€‚

```js
const observer = new MutationObserver(mutations => {
  mutations.forEach(mutation => {
    console.log(mutation.addedNodes);
    console.log(mutation.removedNodes);
  })
});
observer.observe(container, {
  childList: true
});
```
<video src="https://video-obsidian.oss-cn-beijing.aliyuncs.com/MutationObserver-childList3.mp4" controls></video>

### subtree

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè®¾ç½® `childList` ä¸º `true`ï¼Œåªèƒ½ç›‘å¬**ç›´æ¥å­å…ƒç´ **çš„æ–°å¢ä¸åˆ é™¤ï¼Œå¯¹äºæ›´æ·±å±‚æ¬¡çš„å­å…ƒç´ çš„å˜åŒ–æ— æ³•ç›‘å¬ã€‚

<Tabs>
<TabItem value='html' label='HTML' default>

```html
<div id="container">
  <div id="inner-container">
    <p>ä¸–ç•Œè¿™ä¹ˆå¤§ï¼Œæˆ‘æƒ³å»çœ‹çœ‹</p>
  </div>
</div>
<button id="btn">åˆ é™¤/æ–°å¢</button>
```

</TabItem>

<TabItem value='js' label='JavaScript'>

```js
const container = document.querySelector('#container');
const observer = new MutationObserver(mutations => {
  console.log(mutations);
});
observer.observe(container, {
  childList: true
});
    
const btn = document.querySelector('#btn');
btn.addEventListener('click', () => {
  const innerContainer = document.querySelector('#inner-container');
  const p = innerContainer.querySelector('p');
  if (p) {
    innerContainer.removeChild(p);
  } else {
    innerContainer.innerHTML = '<p>ä¸–ç•Œè¿™ä¹ˆå¤§ï¼Œæˆ‘æƒ³å»çœ‹çœ‹</p>';
  }
});
```  

</TabItem>
</Tabs>

ç›¸æ¯”äºä¸Šä¾‹ï¼Œåœ¨ `p` æ ‡ç­¾ä¸ `container` ä¹‹é—´æ·»åŠ äº†ä¸€ä¸ª `inner-container` å…ƒç´ ï¼Œæˆ‘ä»¬è¿˜æ˜¯ç›‘å¬ `container` å…ƒç´ ï¼Œç‚¹å‡»æŒ‰é’®æ—¶å¯¹ `p` æ ‡ç­¾è¿›è¡Œç§»é™¤æˆ–è€…æ·»åŠ ã€‚

<video controls src="https://video-obsidian.oss-cn-beijing.aliyuncs.com/MutationObserver-childList2.mp4"></video>

å› ä¸ºåªèƒ½ç›‘å¬ç›´æ¥å­å…ƒç´ ï¼Œè€Œ `p` æ ‡ç­¾å¹¶ä¸æ˜¯ `container` çš„ ç›´æ¥å­å…ƒç´ ï¼Œæ‰€ä»¥ `p` æ ‡ç­¾çš„åˆ é™¤ä¸æ–°å¢æ— æ³•è¢«ç›‘å¬åˆ°ï¼Œæ‰€ä»¥å›è°ƒå‡½æ•°ä¸ä¼šè¢«æ‰§è¡Œï¼Œæ§åˆ¶å°ä¸ä¼šæœ‰ä»»ä½•çš„è¾“å‡ºã€‚

é‚£æœ‰æ²¡æœ‰åŠæ³•è¿›è¡Œæ·±å±‚æ¬¡çš„ç›‘å¬å‘¢ï¼Ÿç­”æ¡ˆæ˜¯æœ‰ï¼Œéœ€è¦é…åˆ `subtree` å±æ€§ã€‚é™¤äº†éœ€è¦æŒ‡å®š `childList` ä¸º `true` ä»¥å¤–è¿˜éœ€è¦æŒ‡å®š `subtree` ä¸º `true`ã€‚

<Tabs>
<TabItem value='html' label='HTML' default>

```html
<div id="container">
  <div id="inner-container">
    <p>ä¸–ç•Œè¿™ä¹ˆå¤§ï¼Œæˆ‘æƒ³å»çœ‹çœ‹</p>
  </div>
</div>
<button id="btn">åˆ é™¤/æ–°å¢</button>
```

</TabItem>

<TabItem value='js' label='JavaScript'>

```js
const container = document.querySelector('#container');
const observer = new MutationObserver(mutations => {
  console.log(mutations);
});
observer.observe(container, {
  childList: true,
  subtree: true
});
    
const btn = document.querySelector('#btn');
btn.addEventListener('click', () => {
  const innerContainer = document.querySelector('#inner-container');
  const p = innerContainer.querySelector('p');
  if (p) {
    innerContainer.removeChild(p);
  } else {
    innerContainer.innerHTML = '<p>ä¸–ç•Œè¿™ä¹ˆå¤§ï¼Œæˆ‘æƒ³å»çœ‹çœ‹</p>';
  }
});
```  

</TabItem>
</Tabs>

<video controls src="https://video-obsidian.oss-cn-beijing.aliyuncs.com/MutationObserver-childList4.mp4"></video>

## é€šè¿‡ `attributes` æ¥ç›‘å¬å±æ€§çš„å˜åŒ–

### attributes

å½“è®¾ç½® `attributes` å±æ€§ä¸º `true` æ—¶ï¼Œå°±å¯ä»¥ç›‘å¬åˆ°å±æ€§çš„å˜åŒ–ï¼ŒåŒ…æ‹¬è‡ªå®šä¹‰å±æ€§ã€‚

<Tabs>
<TabItem value='html' label='HTML' default>

```html
<div id="container" class="red">
  <p>ä¸–ç•Œè¿™ä¹ˆå¤§ï¼Œæˆ‘æƒ³å»çœ‹çœ‹</p>
</div>
<button id="btn">æ”¹å˜é¢œè‰²</button>
```

</TabItem>

<TabItem value='css' label='CSS'>

```css
.red {
  color: red;
}
.green {
  color: green;
}
```

</TabItem>

<TabItem value='js' label='JavaScript'>

```js
const container = document.querySelector('#container');
const observer = new MutationObserver(mutations => {
  console.log(mutations);
});
observer.observe(container, {
  attributes: true
});

const btn = document.querySelector('#btn');
btn.addEventListener('click', () => {
  container.classList.toggle('red');
  container.classList.toggle('green');
});
```  

</TabItem>
</Tabs>

åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæ¯æ¬¡ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œéƒ½ä¼šå¯¹ `container` çš„ç±»åè¿›è¡Œæ”¹å˜ï¼Œäº¤æ›¿çš„æ·»åŠ å’Œåˆ é™¤ `red` å’Œ `green` ç±»ï¼Œä»è€Œä½¿å¾—æ–‡å­—çš„æ ·å¼å‘ç”Ÿå˜åŒ–ã€‚

<video controls src="https://video-obsidian.oss-cn-beijing.aliyuncs.com/MutationObserver-attributes1.mp4"></video>

ä»è§†é¢‘ä¸­çš„æ‰“å°ç»“æœçœ‹ï¼Œæ¯æ¬¡æˆ‘ä»¬ä¿®æ”¹ `class` æ—¶ï¼Œå›è°ƒå‡½æ•°éƒ½è¢«æ‰§è¡Œäº†ï¼Œå¯ä»¥çœ‹åˆ°è¿™æ¬¡çš„æ•°ç»„ä¸­åŒ…å«ä¸¤ä¸ªå…ƒç´ ï¼Œä¸€ä¸ªæ˜¯åˆ é™¤ç±»çš„å˜åŠ¨ï¼Œä¸€ä¸ªæ˜¯æ–°å¢ç±»çš„å˜åŠ¨ã€‚

<img src="https://cdn.staticaly.com/gh/LastKnightCoder/ImgHosting3@master/image.1uex3gw8w2rk.webp" style={{ zoom: '50%'}} />

å¯è§çœ‹åˆ°ï¼Œå±æ€§å˜åŠ¨å¯¹åº”çš„ `MutationRecord` å¯¹è±¡çš„ `type` ä¸º `attributes`ï¼Œé€šè¿‡ `attributeName` å¯ä»¥çŸ¥é“ä»€ä¹ˆå±æ€§å‘ç”Ÿäº†å˜åŒ–ã€‚

### attributeOldValue

é€šè¿‡è®¾ç½® `attributeOldValue` ä¸º `true`ï¼Œå¯ä»¥çŸ¥é“å˜åŠ¨ä¹‹å‰çš„å±æ€§å€¼ã€‚çœ‹ä¸€ä¸ªğŸŒ°

<Tabs>
<TabItem value='html' label='HTML' default>

```html
<div id="container" data-text="Hello World"></div>
<button id="btn">æ”¹å˜è‡ªå®šä¹‰å±æ€§</button>
```

</TabItem>

<TabItem value='css' label='CSS'>

```css
#container::before {
  content: attr(data-text);
}
```

</TabItem>

<TabItem value='js' label='JavaScript'>

```js
const container = document.querySelector('#container');
const observer = new MutationObserver(mutations => {
  mutations.forEach(mutation => {
    console.log(mutation.oldValue);
  });
});
observer.observe(container, {
  attributes: true,
  attributeOldValue: true
});

const texts = ['Hello World', 'ä½ å¥½ä¸–ç•Œ'];
let count = 0;
const btn = document.querySelector('#btn');
btn.addEventListener('click', () => {
  container.dataset.text = texts[++count % 2];
});
```  

</TabItem>
</Tabs>

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä¸º `container` å…ƒç´ è®¾ç½®äº†è‡ªå®šä¹‰å±æ€§ `data-text`ï¼Œå¹¶è®¾ç½®å…¶ä¼ªå…ƒç´  `::before` çš„ `content` ä¸º `data-text`ï¼Œéšåæˆ‘ä»¬ç‚¹å‡»æŒ‰é’®ï¼Œæ”¹å˜ `data-text` çš„å€¼ï¼Œ`content` éšä¹‹æ”¹å˜ï¼Œé¡µé¢å‘ç”Ÿå˜åŒ–ã€‚æˆ‘ä»¬ä½¿ç”¨ `MutationObserver` æ£€æµ‹åˆ°è¿™ä¸€å˜åŒ–ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ `MutationRecord` å¯¹è±¡çš„ `oldValue` å±æ€§æ¥è®¿é—®åˆ°å˜åŒ–ä¹‹å‰çš„å±æ€§å€¼ã€‚

<video controls src="https://video-obsidian.oss-cn-beijing.aliyuncs.com/MutationObserver-attrOldValue.mp4?x=2"></video>

### attributeFilter

é€šè¿‡æŒ‡å®š `attributeFilter` å±æ€§ï¼Œå¯ä»¥åªå…³ç›‘å¬ç‰¹å®šå±æ€§çš„å˜åŒ–ï¼Œå®ƒçš„å€¼ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œåªç›‘å¬æ•°ç»„ä¸­åŒ…å«çš„å±æ€§çš„å˜åŒ–

<Tabs>

<TabItem value='html'label='HTML'>

```html
<div class="red" id="container" data-text="Hello World"></div>
<button id="btn">æ”¹å€¼ä¸æ”¹è‰²</button>
```

</TabItem>

<TabItem value='css'label='CSS'>

```css
#container::before {
  content: attr(data-text);
}
.red {
  color: red;
}
.green {
  color: green;
}
```

</TabItem>

<TabItem value='js'label='JavaScript'>

```javascript
const container = document.querySelector('#container');
const observer = new MutationObserver(mutations => {
  mutations.forEach(mutation => {
    // æ‰“å°å‡ºå˜åŠ¨çš„å±æ€§
    console.log(mutation.attributeName);
  })
});
observer.observe(container, {
  attributes: true,
  // åªç›‘å¬ data-text çš„å˜åŒ–
  attributeFilter: ['data-text']
});

let count = 0;
const texts = ['Hello World', 'ä½ å¥½ä¸–ç•Œ'];
const btn = document.querySelector('#btn');
btn.addEventListener('click', () => {
  container.classList.toggle('red');
  container.classList.toggle('green');
  container.dataset.text = texts[++count % 2];
});
```

</TabItem>

</Tabs>

åœ¨ä¸Šé¢æˆ‘ä»¬åŒæ—¶æ”¹å˜ `class` å±æ€§ä¸ `data-text` å±æ€§ï¼Œä½†æ˜¯åœ¨ `options` ä¸­æˆ‘ä»¬è®¾ç½®äº† `attributeFilter: ['data-text']`ï¼Œå³åªç›‘å¬ `data-text` å±æ€§ã€‚æˆ‘ä»¬åœ¨å›è°ƒå‡½æ•°ä¸­æ‰“å°å‡ºç›‘å¬çš„å±æ€§ã€‚

<video controls src="https://video-obsidian.oss-cn-beijing.aliyuncs.com/MutationObserver-attrFilter.mp4"></video>

ä»è§†é¢‘ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåªæ‰“å°äº† `data-text`ï¼Œå¹¶æ²¡æœ‰æ‰“å° `class`ã€‚

### subtree

`attributes` å±æ€§ä¹Ÿå¯ä»¥é…åˆ `subtree` ä½¿ç”¨ï¼Œé™¤äº†å¯ä»¥ç›‘å¬æŒ‡å®šå…ƒç´ ä¸Šå±æ€§çš„å˜åŒ–ï¼Œè¿˜å¯ä»¥ç›‘å¬åˆ°è¯¥å…ƒç´ åŒ…å«çš„å­å…ƒç´ ä¸Šçš„å±æ€§çš„å˜åŒ–ã€‚

<Tabs>

<TabItem value='html'label='HTML'>

```html
<div id="container">
  <p class="red">Hello World!</p>
</div>
```

</TabItem>

<TabItem value='css'label='CSS'>

```css
.red {
  color: red;
}
.green {
  color: green;
}
```

</TabItem>

<TabItem value='js'label='JavaScript'>

```javascript
const container = document.querySelector('#container');
const observer = new MutationObserver(mutations => {
  mutations.forEach(mutation => {
    console.log(mutation);
  });
});
observer.observe(container, {
  attributes: true,
  subtree: true
});

setTimeout(()=> {
  const p = container.querySelector('p');
  p.className = 'green';
}, 3000);
```

</TabItem>

</Tabs>

åœ¨ `container` é‡Œé¢æœ‰ä¸€ä¸ª `p` æ ‡ç­¾ï¼Œ`p` æ ‡ç­¾åŒ…å«ä¸€ä¸ª `class` å±æ€§ã€‚æˆ‘ä»¬ä½¿ç”¨ 
`MutationObserver` ç›´æ¥ç›‘å¬ `container`ï¼Œç„¶åå¼€å¯ä¸€ä¸ªå®šæ—¶å™¨ï¼Œåœ¨å®šæ—¶å™¨ä¸­ä¿®æ”¹ `p` æ ‡ç­¾çš„ `class` å±æ€§ï¼Œç”±äºåœ¨ `options` ä¸­è®¾ç½®äº† `subtree: true`ï¼Œæ‰€ä»¥å³ä½¿æˆ‘ä»¬ç›‘å¬çš„æ˜¯ `container`ï¼Œä½†æ˜¯ `p` æ ‡ç­¾å±æ€§çš„å˜åŒ–è¿˜æ˜¯èƒ½è¢«ç›‘å¬åˆ°ã€‚

<video controls src="https://video-obsidian.oss-cn-beijing.aliyuncs.com/MutationObserver-attributes2.mp4"></video>

## é€šè¿‡ `characterData` æ¥ç›‘å¬æ–‡æœ¬çš„å˜åŒ–

### characterData

é€šè¿‡å°† `characterData` è®¾ç½®ä¸º `true` æ¥ç›‘å¬æ–‡æœ¬èŠ‚ç‚¹çš„å˜åŒ–ã€‚å…¶ç›¸åº”çš„ `MutationRecord` å¯¹è±¡çš„ `type` å±æ€§ä¸º `characterData`ã€‚

<Tabs>

<TabItem value='html'label='HTML'>

```html
<div id="container" contenteditable="true">ä¸–ç•Œè¿™ä¹ˆå¤§ï¼Œæˆ‘æƒ³å»çœ‹çœ‹</div>
```

</TabItem>

<TabItem value='js'label='JavaScript'>

```javascript
const container = document.querySelector('#container');
const observer = new MutationObserver(mutations => {
  mutations.forEach(mutation => {
    console.log(mutation);
  });
});
observer.observe(container.firstChild, {
  characterData: true
});
```

</TabItem>

</Tabs>

æˆ‘ä»¬å‡†å¤‡äº†ä¸€ä¸ª `div`ï¼Œå¹¶ä¸”è®¾ç½®äº†å…¶ `contenteditable` å±æ€§ä¸º `true`ï¼Œå³å†…éƒ¨æ–‡å­—å¯ç¼–è¾‘ã€‚éšåæˆ‘ä»¬ç›‘å¬äº† `div` ä¸‹çš„æ–‡æœ¬èŠ‚ç‚¹ï¼Œè®¾ç½®äº† `characterData` å±æ€§ä¸º `true`ï¼Œå³ç›‘å¬æ–‡å­—çš„å˜åŒ–ã€‚

<video controls src="https://video-obsidian.oss-cn-beijing.aliyuncs.com/MutationObserver-characterData1.mp4"></video>

:::note note

1. å½“ä½¿ç”¨ <kbd>Ctrl + B</kbd> æˆ–è€… <kbd>Ctrl + I</kbd> ä½¿å¾—æ–‡æœ¬åŠ ç²—æˆ–è€…å€¾æ–œæ—¶ï¼Œä¼šä½¿å¾—åŸæ–‡æœ¬èŠ‚ç‚¹å˜ä¸ºå¤šä¸ªèŠ‚ç‚¹ï¼Œè¿™æ—¶ä½ å†ç¼–è¾‘æ–‡å­—ï¼Œä¼šå‘ç° `MutationObserver` ä¸èµ·ä½œç”¨ï¼Œé™¤éä½ ç¼–è¾‘çš„æ–‡å­—è¢«è®¤ä¸ºæ˜¯åŸå§‹çš„æ–‡æœ¬èŠ‚ç‚¹ã€‚
2. å½“ä½ å°†æ–‡æœ¬èŠ‚ç‚¹åŒ…å«çš„æ‰€æœ‰æ–‡å­—éƒ½åˆ é™¤åï¼Œ`MutationObserver` ä¸å†è§¦å‘å›è°ƒå‡½æ•°ï¼Œå› ä¸ºä¸€æ—¦æ–‡å­—åˆ é™¤åï¼ŒåŸæ–‡æœ¬èŠ‚ç‚¹å°±è¢«ç§»é™¤äº†ï¼Œå†æ¬¡è¾“å…¥çš„æ–‡å­—å½¢æˆäº†ä¸€ä¸ªæ–°çš„æ–‡æœ¬èŠ‚ç‚¹ï¼Œè€Œè¿™ä¸ªæ–‡æœ¬èŠ‚ç‚¹å¹¶æ²¡æœ‰è¢«ç›‘å¬ã€‚å¦‚æœä»¥ `childList: true` ç›‘å¬æ–‡æœ¬èŠ‚ç‚¹çˆ¶å®¹å™¨ï¼Œå¯ä»¥è§‚å¯Ÿåˆ°åˆ é™¤æ‰€æœ‰æ–‡æœ¬çš„æ—¶å€™ä¼šè§¦å‘ä¸€æ¬¡å›è°ƒå‡½æ•°ï¼Œå› ä¸ºæ­¤æ—¶æ–‡æœ¬èŠ‚ç‚¹è¢«åˆ é™¤äº†ï¼Œè€Œåˆ å®Œä¹‹åæ–°å¢æ–‡å­—åˆä¼šè§¦å‘ä¸€æ¬¡å›è°ƒå‡½æ•°ï¼Œå› ä¸ºæ­¤æ—¶æ–°å¢äº†ä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹ã€‚
3. è¾“å…¥ä¸­æ–‡å­—ç¬¦æ—¶ `MutationObserver`æ— æ³•ç›‘å¬åˆ°å¯¹åº”å˜åŒ–ã€‚

:::

### subtree

ä»¥ä¸Šä¸‰ä¸ªé—®é¢˜å‡å¯ä»¥é€šè¿‡é…åˆ `subtree` æ¥è§£å†³ï¼Œå½“è®¾ç½® `subtree` ä¸º `true` æ—¶ï¼Œå¯ä»¥ç›‘å¬åˆ°å­èŠ‚ç‚¹ä¸­æ–‡æœ¬çš„å˜åŒ–ï¼Œæ‰€ä»¥ä¸ç®¡æ˜¯åˆ†è£‚ä¸ºå¤šä¸ªèŠ‚ç‚¹è¿˜æ˜¯åŸèŠ‚ç‚¹è¢«åˆ é™¤ç„¶åæ–°å¢ï¼Œæ‰€æœ‰æ–‡æœ¬çš„å˜åŒ–éƒ½å¯ä»¥è¢«æ£€æµ‹åˆ°ã€‚

```js
const container = document.querySelector('#container');
const observer = new MutationObserver(mutations => {
  mutations.forEach(mutation => {
    console.log(mutation);
  });
});
observer.observe(container, {
  characterData: true,
  subtree: true
});
```

<video controls src="https://video-obsidian.oss-cn-beijing.aliyuncs.com/MutationObserver-characterData2.mp4"></video>

:::note note
é€‰æ‹©æ–‡å­—ç„¶åè¿›è¡Œåˆ é™¤ï¼Œè¿™ä¸ªæ–‡æœ¬å˜åŒ–å¥½åƒæ£€æŸ¥ä¸åˆ°ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œè·Ÿé€‰åŒºæœ‰å…³å—ï¼Ÿ
:::

### characterDataOldValue 

è®¾ç½® `characterDataOldValue` ä¸º `true` åï¼Œå¯ä»¥é€šè¿‡ `MutationRecord` å¯¹è±¡çš„ `oldValue` å±æ€§è·å¾—å˜åŠ¨ä¹‹å‰çš„æ–‡æœ¬ã€‚

```js
const container = document.querySelector('#container');
const observer = new MutationObserver(mutations => {
  mutations.forEach(mutation => {
    console.log(mutation.oldValue);
  });
});
observer.observe(container, {
  characterData: true,
  characterDataOldValue: true,
  subtree: true,
});
```

<video controls src="https://video-obsidian.oss-cn-beijing.aliyuncs.com/MutationObserver-chatacterData3.mp4"></video>

## é€šè¿‡ `takeRecords` æ‹¦æˆªå˜åŒ–

é€šè¿‡ `takeRecords()` æ–¹æ³•ï¼Œå¯ä»¥åœ¨ `mutations` è¢«å›è°ƒå‡½æ•°å¤„ç†ä¹‹å‰æ‹¦æˆªåˆ°ã€‚

<Tabs>

<TabItem value='html'label='HTML'>

```html
<ul id="list">
  <li>ç¯®çƒ</li>
  <li>è¶³çƒ</li>
  <li>ç¾½æ¯›çƒ</li>
</ul>
```

</TabItem>

<TabItem value='js'label='JavaScript'>

```javascript
const list = document.querySelector('#list');
const observer = new MutationObserver(mutations => {
  console.log('callback:', mutations);
});
observer.observe(list, {
  childList: true
});

setTimeout(() => {
  list.insertAdjacentHTML('beforeend', '\\n<li>ä¹’ä¹“çƒ</li>');
  const records = observer.takeRecords();
  console.log('takeRecords:', records);
}, 3000);
```

</TabItem>

</Tabs>

ä¸Šé¢æˆ‘ä»¬å‡†å¤‡äº†ä¸€ä¸ªåˆ—è¡¨ï¼Œä½¿ç”¨ä¸€ä¸ªå®šæ—¶å™¨å‘åˆ—è¡¨ä¸­æ·»åŠ ä¸€é¡¹å†…å®¹ï¼Œæ·»åŠ å†…å®¹ä¹‹åï¼Œæˆ‘ä»¬é©¬ä¸Šä½¿ç”¨ `takeRecords()` è¿›è¡Œäº†æ‹¦æˆªï¼Œå› æ­¤ä¸ä¼šè§¦å‘å›è°ƒå‡½æ•°çš„æ‰§è¡Œã€‚

<video src="https://video-obsidian.oss-cn-beijing.aliyuncs.com/MutationObserver-takeRecords.mp4" controls></video>

## ç›‘å¬å¤šä¸ªå…ƒç´ 

åŒä¸€ä¸ª `MutationObserver` å¯ä»¥åŒæ—¶ç›‘å¬å¤šä¸ªå…ƒç´ ï¼Œå¯é€šè¿‡ `disconnect` å–æ¶ˆæ‰€æœ‰å…ƒç´ çš„ç›‘å¬ã€‚

<Tabs>

<TabItem value='html'label='HTML'>

```html
<div id="text1" contenteditable="true">Hello World!</div>
<div id="text2" contenteditable="true">ä½ å¥½ï¼Œä¸–ç•Œï¼</div>
<button id="btn1">ç›‘å¬text1</button>
<button id="btn2">ç›‘å¬text2</button>
<button id="stopBtn">å–æ¶ˆç›‘å¬</button>
```

</TabItem>

<TabItem value='js'label='JavaScript'>

```javascript
const observer = new MutationObserver(mutations => {
  console.log(mutations);
});

btn1.addEventListener('click', () => {
  observer.observe(text1, {
    characterData: true,
    subtree: true
  });
});
btn2.addEventListener('click', () => {
  observer.observe(text2, {
    characterData: true,
    subtree: true
  });
});
stopBtn.addEventListener('click', () => {
  observer.disconnect();
});
```

</TabItem>

</Tabs>

<video controls src="https://video-obsidian.oss-cn-beijing.aliyuncs.com/MutationObserver-disconnect.mp4"></video>

:::info info
è°ƒç”¨ `disconnect()` ä¼šå–æ¶ˆæ‰€æœ‰å…ƒç´ çš„ç›‘å¬ï¼Œè¿™æ˜¯æˆ‘è§‰å¾—ä¸æ–¹ä¾¿çš„åœ°æ–¹ï¼Œä¸åƒ `IntersectionObserver` å¯ä»¥é€šè¿‡ `unobserve()` æ–¹æ³•å–æ¶ˆç›‘å¬æŒ‡å®šçš„å…ƒç´ ã€‚
:::
